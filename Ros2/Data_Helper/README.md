# HelperPathSender – DQN-Based Path Distribution & Stop Management

## Overview

The `HelperPathSender` node is responsible for publishing waypoints in real time based on a precomputed path sequence generated by a reinforcement learning (DQN) policy.  
It handles segment transitions, determines when the vehicle should stop at predefined locations (pickup/dropoff), and publishes corresponding stop and mission state signals.  
Each path segment is stored in a `waypoints_{id}.json` file and loaded dynamically as the vehicle moves along the route.

---

## Core Functions

- Loads the full path node sequence from `dqn_paths.json`
- Loads stop points from `stops.json` and publishes `/stop`, `/pickup_dropoff` at those points
- Loads and publishes waypoints (`/path_x`, `/path_y`) per segment
- Detects arrival at the end of each segment based on live `/location`
- Switches segments automatically and preloads the next
- Publishes `/path_mode` based on the type of the current segment:
  - `0`: straight
  - `1`: curve
  - `2`: start/finish

---

## Practical Issues and Fixes

| Issue | Fix |
|-------|-----|
| First waypoints were skipped during transition | Added `preload_buffer()` with delay-safe logic |
| `sleep()` caused entire system freeze at stops | Replaced with tick-based asynchronous timer |
| `stops.json` was nested list (invalid) | Auto-flattened input during loading |
| Duplicate node IDs caused repeated waypoint segments | Cleaned JSON structure and added validation |
| `/stop` not received consistently | Confirmed manual publish timing and QoS |

---

## ROS2 Topics

| Topic              | Type                | Direction | Description                                 |
|--------------------|---------------------|-----------|---------------------------------------------|
| `/location`        | `geometry_msgs/Point` | Sub      | Real-time vehicle position from SLAM        |
| `/dqn_done`        | `std_msgs/Bool`     | Sub       | DQN planning complete trigger               |
| `/path_x`, `/path_y` | `std_msgs/Float32`| Pub       | Real-time waypoint x/y coordinates          |
| `/path_mode`       | `std_msgs/Int32`    | Pub       | Segment type (straight, curve, etc.)        |
| `/pickup_dropoff`  | `std_msgs/Int32`    | Pub       | Mission state: 1 = pickup, 2 = dropoff      |
| `/stop`            | `std_msgs/Int32`    | Sub/Pub   | Vehicle stop control flag                   |

---

## Node Logic Summary

1. Waits for `/dqn_done` signal  
2. Loads `dqn_paths.json` into a queue  
3. Loads the first segment's waypoints and starts publishing to `/path_x`, `/path_y`  
4. Monitors `/location`; when near end of segment → preload next segment  
5. If current segment is a stop node:
   - Publishes `/pickup_dropoff` (1 or 2)
   - Publishes `/stop` with value `1`
   - Waits ~5 seconds using tick counter
   - Resumes path publishing after wait

---

## Files

- `helper_path_sender.py`: Main ROS2 node script  
- `dqn_paths.json`: Full sequence of node IDs from RL planner  
- `waypoints_*.json`: Per-node waypoint coordinate files  
- `stops.json`: List of stop point node IDs  
- `datahelper_launch.py`: Launch file for the helper node

